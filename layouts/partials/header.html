{{- $isZH := eq .Site.Language.Lang "zh-hant" -}}
{{- $home := cond $isZH "/zh-hant/" "/" -}}
{{- $posts := printf "%sposts/" $home -}}
{{- $about := printf "%sabout/" $home -}}
<header class="site-header">
  <div class="site-header-inner">
    <div class="site-brand">
      <a href="{{ $home }}">{{ .Site.Title }}</a>
    </div>

    <nav class="main-nav">
      <ul>
        <li><a href="{{ $home }}" class="{{ if .IsHome }}active{{ end }}">🏠 {{ if $isZH }}首頁{{ else }}Home{{ end }}</a></li>
        <li><a href="{{ $posts }}" class="{{ if or (eq .Section "posts") (in .RelPermalink "/posts/") }}active{{ end }}">📄 {{ if $isZH }}文章{{ else }}Posts{{ end }}</a></li>
        <li><a href="{{ $about }}" class="{{ if in .RelPermalink "/about/" }}active{{ end }}">ℹ️ {{ if $isZH }}關於{{ else }}About{{ end }}</a></li>
      </ul>
    </nav>

    <div class="top-action-group">
      <div class="custom-topbuttons">
        <div class="cb-menu">
          <a class="cb-btn lang-switch" href="{{ if $isZH }}/{{ else }}/zh-hant/{{ end }}">🌐 {{ if $isZH }}English{{ else }}漢語{{ end }}</a>
          <button class="cb-btn" id="themeToggle" type="button">🌓 {{ if $isZH }}黑暗{{ else }}Dark{{ end }}</button>
        </div>
      </div>

      <button class="cb-toggle mobile-only"
              aria-label="Menu"
              aria-controls="mobileMenu"
              onclick="document.getElementById('mobileMenu').classList.toggle('open')">☰</button>

      <div id="mobileMenu" class="cb-menu mobile-only">
        <a class="cb-btn" href="{{ $home }}">🏠 {{ if $isZH }}首頁{{ else }}Home{{ end }}</a>
        <a class="cb-btn" href="{{ $posts }}">📄 {{ if $isZH }}文章{{ else }}Posts{{ end }}</a>
        <a class="cb-btn" href="{{ $about }}">ℹ️ {{ if $isZH }}關於{{ else }}About{{ end }}</a>
      </div>
    </div>
  </div>
</header>

<script>
(function(){
  // 防重入
  if (window.__THEME_TOGGLE_INIT) return;
  window.__THEME_TOGGLE_INIT = true;

  const root = document.documentElement;
  const body = document.body;
  const isZH = (root.lang || '').toLowerCase().startsWith('zh');
  const KEY = 'site-theme';
  const btn = document.getElementById('themeToggle');

  function systemPref(){
    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  }

  // 產生顯示「要切換去」的模式文字
  function nextLabel(nextMode){
    if (isZH) return nextMode === 'dark' ? '🌓 黑暗' : '🌞 明亮';
    return nextMode === 'dark' ? '🌓 Dark' : '🌞 Light';
  }

  function updateButton(currentMode){
    if(!btn) return;
    const next = currentMode === 'dark' ? 'light' : 'dark';
    btn.textContent = nextLabel(next);
  }

  function apply(mode){
    const dark = mode === 'dark';
    root.classList.toggle('dark', dark);
    body.classList.toggle('dark', dark);
    updateButton(mode);
  }

  function toggle(){
    const target = root.classList.contains('dark') ? 'light' : 'dark';
    apply(target);
    localStorage.setItem(KEY, target);
  }

  // 初始化
  apply(localStorage.getItem(KEY) || systemPref());

  if(btn) btn.addEventListener('click', toggle);

  // 視窗放大時自動收起手機菜單
  window.addEventListener('resize', () => {
    if (window.innerWidth > 900){
      const m = document.getElementById('mobileMenu');
      if (m) m.classList.remove('open');
    }
  });
})();
</script>
      const m = document.getElementById('mobileMenu');
      if(m) m.classList.remove('open');
    }
  });
})();
</script>
    const target = nowDark ? 'light':'dark';
    apply(target);
    localStorage.setItem(KEY, target);
  });
  window.addEventListener('resize', ()=> {
    if(window.innerWidth > 900){
      const m = document.getElementById('mobileMenu');
      if(m) m.classList.remove('open');
    }
  });
})();
</script>
