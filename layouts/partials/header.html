{{- $isZH := eq .Site.Language.Lang "zh-hant" -}}
{{- $home := cond $isZH "/zh-hant/" "/" -}}
{{- $posts := printf "%sposts/" $home -}}
{{- $about := printf "%sabout/" $home -}}
{{- $rel := .RelPermalink -}}
{{- $switch := cond $isZH (replace $rel "/zh-hant/" "/" 1) (printf "/zh-hant%s" $rel) -}}
<header class="site-header" data-build-hash="hdr-v3">
  <div class="site-header-inner">
    <div class="site-brand">
      <a href="{{ $home }}">{{ .Site.Title }}</a>
    </div>

    <nav class="main-nav">
      <ul>
        <li><a href="{{ $home }}" class="{{ if .IsHome }}active{{ end }}">🏠 {{ if $isZH }}首頁{{ else }}Home{{ end }}</a></li>
        <li><a href="{{ $posts }}" class="{{ if or (eq .Section "posts") (in .RelPermalink "/posts/") }}active{{ end }}">📄 {{ if $isZH }}文章{{ else }}Posts{{ end }}</a></li>
        <li><a href="{{ $about }}" class="{{ if in .RelPermalink "/about/" }}active{{ end }}">ℹ️ {{ if $isZH }}關於{{ else }}About{{ end }}</a></li>
      </ul>
    </nav>

    <div class="top-action-group">
      <div class="custom-topbuttons">
        <div class="cb-menu">
          <a class="cb-btn lang-switch" href="{{ $switch }}">🌐 {{ if $isZH }}English{{ else }}漢語{{ end }}</a>
          <button class="cb-btn" id="themeToggle" type="button">🌓 {{ if $isZH }}黑暗{{ else }}Dark{{ end }}</button>
        </div>
      </div>

      <button class="cb-toggle mobile-only"
              aria-label="Menu"
              aria-controls="mobileMenu"
              onclick="document.getElementById('mobileMenu').classList.toggle('open')">☰</button>

      <div id="mobileMenu" class="cb-menu mobile-only">
        <a class="cb-btn" href="{{ $home }}">🏠 {{ if $isZH }}首頁{{ else }}Home{{ end }}</a>
        <a class="cb-btn" href="{{ $posts }}">📄 {{ if $isZH }}文章{{ else }}Posts{{ end }}</a>
        <a class="cb-btn" href="{{ $about }}">ℹ️ {{ if $isZH }}關於{{ else }}About{{ end }}</a>
      </div>
    </div>
  </div>
</header>

<!-- 早期清理（防止舊殘碼在首屏可見） -->
<script>
(function(){
  const PATS=[/nowDark\s*\?\s*'light':'dark'/,/toggleTheme/,/apply\(target\)/,/const\s+target\s*=\s*nowDark/];
  const bad=[];
  // 只掃描 body 直接子文字節點與 header 後第一層兄弟
  [...document.body.childNodes].forEach(n=>{
    if(n.nodeType===3){
      const txt=n.textContent.trim();
      if(txt && PATS.some(p=>p.test(txt))) bad.push(n);
    }
    if(n.tagName==='HEADER'){
      let m=n.nextSibling;
      let steps=0;
      while(m && steps<6){
        if(m.nodeType===3){
          const t=m.textContent.trim();
          if(t && PATS.some(p=>p.test(t))) bad.push(m);
        }
        m=m.nextSibling;steps++;
      }
    }
  });
  bad.forEach(n=>n.parentNode&&n.parentNode.removeChild(n));
})();
</script>

<!-- 主題切換腳本（唯一） -->
<script>
(function(){
  if (window.__THEME_TOGGLE_INIT) return;
  window.__THEME_TOGGLE_INIT = true;
  const root=document.documentElement, body=document.body;
  const isZH=(root.lang||'').toLowerCase().startsWith('zh');
  const KEY='site-theme', btn=document.getElementById('themeToggle');
  function sysPref(){return matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light';}
  function nextLabel(next){return isZH?(next==='dark'?'🌓 黑暗':'🌞 明亮'):(next==='dark'?'🌓 Dark':'🌞 Light');}
  function updateLabel(cur){ if(!btn)return; const nxt=cur==='dark'?'light':'dark'; btn.textContent=nextLabel(nxt); }
  function apply(mode){ const dark=mode==='dark'; root.classList.toggle('dark',dark); body.classList.toggle('dark',dark); updateLabel(mode); }
  function toggle(){ const target=root.classList.contains('dark')?'light':'dark'; apply(target); localStorage.setItem(KEY,target); }
  apply(localStorage.getItem(KEY)||sysPref());
  btn&&btn.addEventListener('click',toggle);
  addEventListener('resize',()=>{ if(innerWidth>900){ const m=document.getElementById('mobileMenu'); m&&m.classList.remove('open'); }});
})();
</script>

<!-- 次級補掃描：延遲 0/120ms/500ms 三次清理 -->
<script src="/js/stray-cleanup.js?v=3" defer></script>
<!-- END header partial -->
      const m = document.getElementById('mobileMenu');
      if (m) m.classList.remove('open');
    }
  });
})();
</script>

<!-- 自動清理 & 診斷：移除任何殘留舊 JS 純文字 -->
<script>
(function(){
  const PATTERNS = [
    /nowDark\s*\?\s*'light':'dark'/,
    /apply\(target\)/,
    /toggleTheme/,
    /const\s+target\s*=\s*nowDark/
  ];
  let removed = 0;
  const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, null);
  const badNodes = [];
  while(walker.nextNode()){
    const n = walker.currentNode;
    const t = n.textContent.trim();
    if(!t) continue;
    if(PATTERNS.some(p=>p.test(t))){
      badNodes.push(n);
    }
  }
  badNodes.forEach(n=>{
    removed++;
    n.parentNode.removeChild(n);
  });
  if(removed){
    console.warn('[header-cleanup] removed stray script text nodes:', removed);
  }
})();
</script>

<!-- END header partial (檢查點：若再次出現外露文字，請全文 grep `nowDark ? 'light'` 或 `const target = nowDark`) -->
